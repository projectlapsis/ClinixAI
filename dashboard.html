<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/png" href="lo2.png" />
  <title>ClinixAI</title>

  <style>
    :root{
      --bg: #f6f9fb;
      --panel: #ffffff;
      --muted: #6b7280;
      --accent: #0d6efd; /* MSME color */
      --glass: rgba(255,255,255,0.6);
      --radius: 12px;
      --shadow-sm: 0 6px 18px rgba(12, 18, 36, 0.06);
      --shadow-md: 0 10px 30px rgba(12, 18, 36, 0.08);
      --gap: 24px;
      --max-width: 1100px;
    }

    /* Reset + base */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#0f172a}
    a{color:inherit}
    button{font:inherit}

    /* Layout */
    .page {
      display:flex;
      min-height:100vh;
      gap: var(--gap);
      align-items:stretch;
    }

    /* Sidebar */
    .sidebar {
      width:84px;
      padding:24px 14px;
      background:transparent;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:20px;
      border-right:1px solid rgba(15,23,42,0.03);
    }

    .logo {
      width:48px;height:48px;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;
      box-shadow:var(--shadow-sm);background:linear-gradient(180deg,#fff,#f7fbff);
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}

    .side-nav {
      display:flex;flex-direction:column;gap:10px;margin-top:8px;
      width:100%;align-items:center;
    }

    .nav-btn {
      width:100%;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      padding:10px;border-radius:10px;border:none;background:transparent;cursor:pointer;color:var(--muted);
    }
    .nav-btn .ico { font-size:18px }
    .nav-btn .label { font-size:12px; font-weight:600 }
    .nav-btn.active { background:linear-gradient(180deg, rgba(13,110,253,0.08), rgba(13,110,253,0.06)); color:var(--accent) }

    .spacer {flex:1}

    /* Main area */
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:32px;
    }

    .shell {
      width:100%;
      max-width:var(--max-width);
    }

    /* Header */
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:var(--gap);
    }

    .brand-left {display:flex;gap:14px;align-items:center}

    .brand-title {
  font-weight: 900;
  color: var(--accent);
  font-size: 28px;   /* Increased from 20px */
  letter-spacing: 0.5px;
}

    .header-right {display:flex;align-items:center;gap:12px}

    .greeting {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .greeting .hi {font-size:20px;font-weight:700}
    .greeting .sub {font-size:13px;color:var(--muted)}

    .user-pill {
      display:flex;align-items:center;gap:10px;background:var(--panel);padding:8px 12px;border-radius:999px;box-shadow:var(--shadow-sm)
    }
    .user-name {font-weight:700}

    .logout {
      background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;
    }

    /* Quick cards row */
    .quick-row {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
      margin-bottom:var(--gap);
    }

    .card {
      background:var(--panel);
      padding:16px;
      border-radius:12px;
      box-shadow:var(--shadow-sm);
    }
    .card h4{font-size:15px;margin-bottom:6px}
    .card p{font-size:13px;color:var(--muted)}

    /* Content area */
    .content {
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:20px;
      align-items:start;
    }

    /* Main module (chat, symptoms, etc) */
    .module {
      background:var(--panel);
      border-radius:12px;
      padding:18px;
      box-shadow:var(--shadow-md);
      min-height:520px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }

    .module h2 {margin-bottom:6px}

    /* Chat area */
    .chat-area {
      flex:1; display:flex;flex-direction:column;gap:12px;
    }

    .messages {
      flex:1;
      padding:14px;
      border-radius:10px;
      background:linear-gradient(180deg,#fbfdff,#ffffff);
      border:1px solid rgba(15,23,42,0.03);
      overflow:auto;
    }

    .msg {display:flex;margin:10px 0}
    .msg.me {justify-content:flex-end}
    .bubble {
      max-width:70%;
      padding:10px 14px;border-radius:14px;font-size:14px;line-height:1.3;box-shadow:0 6px 12px rgba(2,6,23,0.04)
    }
    .bubble.ai {background:#f0f6ff;color:#0f172a}
    .bubble.me {background:var(--accent);color:white}

    .chat-input {
      display:flex;gap:12px;align-items:center;
    }
    .chat-input input {
      flex:1;padding:12px;border-radius:10px;border:1px solid #e6eefc;font-size:14px;
      outline:none;box-shadow:none;
    }
    .chat-input button {
      background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
    }

    /* Aside panel */
    .aside {
      display:flex;flex-direction:column;gap:16px;
    }
    .aside .panel {background:var(--panel);padding:14px;border-radius:12px;box-shadow:var(--shadow-sm)}
    .aside h4{margin-bottom:8px}

    /* Symptom form */
    .form {display:flex;flex-direction:column;gap:12px}
    .form input,.form textarea,.form select {padding:10px;border-radius:10px;border:1px solid #e6eefc;font-size:14px}
    .primary {background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}

    /* Small screens */
    @media (max-width: 980px){
      .page{flex-direction:column}
      .sidebar{width:100%;height:auto;flex-direction:row;gap:8px;padding:10px;border-right:none;border-bottom:1px solid rgba(15,23,42,0.03)}
      .main{padding:18px}
      .shell{padding:0}
      .quick-row{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
      .content{grid-template-columns:1fr}
      .aside{order:2}
      .module{order:1}
    }
  </style>
</head>
<body>

  <div class="page" role="application">

    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation">
      <div class="logo" title="ClinixAI logo">
        <img src="lo2.png"ClinixAI">
      </div>

      <nav class="side-nav" role="navigation" aria-label="Main">
        <button id="btn-chat" class="nav-btn active" onclick="nav('chat')">
          <span class="ico">üí¨</span>
          <span class="label">Chat</span>
        </button>

        <button id="btn-symptoms" class="nav-btn" onclick="nav('symptoms')">
          <span class="ico">ü©∫</span>
          <span class="label">Symptoms</span>
        </button>

        <button id="btn-reports" class="nav-btn" onclick="nav('reports')">
          <span class="ico">üìÑ</span>
          <span class="label">Reports</span>
        </button>

        <button id="btn-appts" class="nav-btn" onclick="nav('appointments')">
          <span class="ico">üìÖ</span>
          <span class="label">Appts</span>
        </button>
      </nav>

      <div class="spacer" aria-hidden="true"></div>
    </aside>

    <!-- Main content -->
    <main class="main" role="main">
      <div class="shell">

        <!-- Header -->
        <header class="header" role="banner">
          <div class="brand-left">
            <div class="brand-title">ClinixAI</div>
          </div>

          <div class="header-right">
            <div class="greeting" aria-live="polite">
              <div class="hi" id="hiText">Good day</div>
              <div class="sub" id="subText">A short warm health message appears here.</div>
            </div>

            <div class="user-pill" aria-hidden="false">
              <div class="user-name" id="userName">User</div>
            </div>

            <button class="logout" id="logoutBtn" onclick="doLogout()">Logout</button>
          </div>
        </header>

        <!-- Quick cards -->
        <section class="quick-row" aria-label="quick stats">
          <div class="card">
            <h4>Daily Health Tip</h4>
            <p id="tipText">Take a short walk today to boost circulation.</p>
          </div>

          <div class="card">
            <h4>Active Alerts</h4>
            <p id="alerts">No active alerts</p>
          </div>

          <div class="card">
            <h4>Upcoming</h4>
            <p id="upcoming">No upcoming appointments</p>
          </div>

          <div class="card">
            <h4>Records</h4>
            <p id="records">0 saved reports</p>
          </div>
        </section>

        <!-- Content -->
        <section class="content" aria-live="polite">

          <!-- Module area (left) -->
          <div class="module" id="module">

            <!-- Chat -->
            <div id="section-chat">
              <h2>ClinixAI Chat</h2>
              <div class="chat-area">
                <div class="messages" id="messages" aria-live="polite" role="log">
                  <div class="msg"><div class="bubble ai"><strong>ClinixAI:</strong> Hi ‚Äî I'm here to help. Describe your symptoms or ask a health question.</div></div>
                </div>

                <div class="chat-input" role="form" aria-label="Chat input">
                  <input id="chatInput" placeholder="Ask ClinixAI..." onkeydown="if(event.key==='Enter') sendChat()">
                  <button onclick="sendChat()">Send</button>
                </div>
              </div>
            </div>

            <!-- Symptoms -->
            <!-- Symptoms -->
<div id="section-symptoms" style="display:none">
  <h2>Symptom Checker</h2>

  <div style="
    background: #ffffff;
    padding: 24px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    max-width: 540px;
    margin: 0 auto;
  ">
    
    <!-- Description -->
    <div style="margin-bottom: 16px;">
      <label style="font-weight: 600; display:block; margin-bottom:6px;">Describe your symptoms</label>
      <textarea
        id="symText"
        rows="4"
        placeholder="e.g., fever, headache, sore throat"
        style="
          width: 100%;
          padding: 12px;
          border-radius: 10px;
          border: 1px solid #e2e8f0;
          font-size: 14px;
          resize: none;
        "
      ></textarea>
    </div>

    <!-- Duration + Severity -->
    <div style="display:flex; gap:16px; margin-bottom: 16px;">
      <div style="flex:1;">
        <label style="font-weight: 600; display:block; margin-bottom:6px;">Duration</label>
        <select id="symDuration" style="
          width: 100%;
          padding: 12px;
          border-radius: 10px;
          border: 1px solid #e2e8f0;
          font-size: 14px;
        ">
          <option>Less than 24 hours</option>
          <option>1‚Äì3 days</option>
          <option>4‚Äì7 days</option>
          <option>More than a week</option>
        </select>
      </div>

      <div style="flex:1;">
        <label style="font-weight: 600; display:block; margin-bottom:6px;">Severity</label>
        <select id="symSeverity" style="
          width: 100%;
          padding: 12px;
          border-radius: 10px;
          border: 1px solid #e2e8f0;
          font-size: 14px;
        ">
          <option>Mild</option>
          <option>Moderate</option>
          <option>Severe</option>
        </select>
      </div>
    </div>

    <!-- Analyze Button -->
    <button
      class="primary"
      onclick="analyzeSymptoms()"
      style="
        width: 100%;
        background: #0d6efd;
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 15px;
        border: none;
        cursor:pointer;
      "
    >
      Analyze
    </button>

    <!-- Result -->
    <div id="symResult" style="margin-top: 16px; font-size:14px; color:#475569;"></div>

  </div>
</div>


            <!-- Reports -->
            <div id="section-reports" style="display:none">
              <h2>Health Reports</h2>
              <p style="color:var(--muted)">Saved reports and downloads will appear here.</p>
              <div id="reportList" style="margin-top:12px"></div>
            </div>

            <!-- Appointments -->
            <div id="section-appointments" style="display:none">
              <h2>Appointments</h2>
              <form class="form" onsubmit="event.preventDefault(); bookAppt()">
                <input id="apptWith" placeholder="Doctor / Department">
                <input id="apptTime" type="datetime-local">
                <div style="display:flex;gap:12px">
                  <button class="primary" type="submit">Book</button>
                  <div id="apptMsg" style="color:var(--muted);align-self:center"></div>
                </div>
              </form>
              <div id="apptsList" style="margin-top:12px"></div>
            </div>

          </div>

          <!-- Aside (right) -->
          <aside class="aside" aria-label="Sidebar info">
            <div class="panel">
              <h4>Your profile</h4>
              <p><strong id="profileName">User</strong><br/><small id="memberSince">Member since ‚Äî üü¢ 20/11/2025 </small></p>
            </div>

            <div class="panel">
              <h4>Recent activity</h4>
              <p id="recent">No recent activity</p>
              <br></br>
              <p><button class="primary" onclick="openHistory()">View History</button></p>

<div id="historyModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:2000; align-items:center; justify-content:center;">
  <div style="width:800px; max-width:95%; background:#fff; padding:18px; border-radius:12px;">
    <h3>Chat History</h3>
    <div id="historyList" style="max-height:400px; overflow:auto; margin-top:12px; border:1px solid #e5e7eb; padding:12px; border-radius:10px;"></div>
    <div style="text-align:right; margin-top:12px;">
      <button onclick="closeHistory()">Close</button>
    </div>
  </div>
</div>
            </div>


          </aside>

        </section>
      </div>
    </main>
  </div>

<script>
    fetch("https://pavanxd.app.n8n.cloud/webhook/Chatbothook-test/Chatbot")
  .catch(err => console.log("n8n error:", err));  

    // Initialize user & UI
    const username = localStorage.getItem('userName') || 'User';
    if(localStorage.getItem('loggedIn') !== 'true') {
      location.href = 'login.html';
    }

    document.getElementById('userName').textContent = username;
    document.getElementById('profileName').textContent = username;
    document.getElementById('hiText').textContent = `Good day, ${username} üëã`;
    document.getElementById('subText').textContent = `Stay healthy, ${username}! Small daily steps add up to big wellness.`;
    document.getElementById('tipText').textContent = 'Take short walks and stay hydrated.';
    document.getElementById('records').textContent = '0 saved reports';

    // Navigation
    function nav(section){
      const secs = ['chat','symptoms','reports','appointments'];
      secs.forEach(s=>{
        document.getElementById('section-' + s).style.display = (s === section ? '' : 'none');
      });

      const mapping = { chat: 'btn-chat', symptoms: 'btn-symptoms', reports: 'btn-reports', appointments: 'btn-appts' };
      Object.values(mapping).forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById(mapping[section]).classList.add('active');

      if(section === 'chat') setTimeout(()=>document.getElementById('chatInput').focus(),100);
    }

    // ------------------------------
    // UPDATED CHAT WITH HISTORY SAVE
    // ------------------------------
    async function sendChat() {
      const inp = document.getElementById('chatInput');
      const text = inp.value.trim();
      if (!text) return;

      const messages = document.getElementById('messages');

      // User message UI
      const me = document.createElement('div');
      me.className = 'msg me';
      me.innerHTML = `<div class="bubble me">${escapeHtml(text)}</div>`;
      messages.appendChild(me);
      messages.scrollTop = messages.scrollHeight;

      // SAVE USER MESSAGE
      pushHistory("userName", text);

      inp.value = "";

      // ---- SEND TO n8n WORKFLOW ----
      try {
        const res = await fetch("https://pavanxd.app.n8n.cloud/webhook/Chatbot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });

        const data = await res.json();
        const reply = data.output || "No response received.";

        // AI message UI
        const ai = document.createElement('div');
        ai.className = 'msg';
        ai.innerHTML = `<div class="bubble ai">${escapeHtml(reply)}</div>`;
        messages.appendChild(ai);
        messages.scrollTop = messages.scrollHeight;

        // SAVE AI MESSAGE
        pushHistory("assistant", reply);

      } catch (err) {
        const ai = document.createElement('div');
        ai.className = 'msg';
        ai.innerHTML = `<div class="bubble ai">‚ö†Ô∏è Error: Could not contact ClinixAI server.</div>`;
        messages.appendChild(ai);
      }
    }

    // Symptom analysis
    function analyzeSymptoms(){
      const t = document.getElementById('symText').value.trim();
      if(!t){ alert('Please describe your symptoms.'); return; }
      const dur = document.getElementById('symDuration').value;
      const sev = document.getElementById('symSeverity').value;
      document.getElementById('symResult').innerHTML =
        `<div style="padding:10px;border-radius:10px;background:#fbfdff;border:1px solid rgba(13,110,253,0.06)">
          <strong>Preliminary:</strong> Based on "${escapeHtml(t)}" (${escapeHtml(dur)}, ${escapeHtml(sev)}).
          Consider rest and hydration. Seek care if severe.
        </div>`;
      updateRecent(`Symptom check: "${t}"`);
      nav('symptoms');
    }

    // Appointments
    function bookAppt(){
      const who = document.getElementById('apptWith').value.trim();
      const when = document.getElementById('apptTime').value;
      if(!who || !when){ alert('Please enter doctor/department and time.'); return; }
      const li = document.createElement('div');
      li.style.padding='8px 0';
      li.innerHTML =
        `<strong>${escapeHtml(who)}</strong>
         <div style="color:var(--muted);font-size:13px">${new Date(when).toLocaleString()}</div>`;
      document.getElementById('apptsList').prepend(li);
      document.getElementById('upcoming').textContent = '1 appointment scheduled';
      document.getElementById('apptMsg').textContent = 'Booked';
      updateRecent(`Booked: ${who} at ${new Date(when).toLocaleString()}`);
    }

    // Utilities
    function updateRecent(text){
      document.getElementById('recent').textContent = text;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[s]);
    }

    function doLogout(){
      localStorage.removeItem('loggedIn');
      location.href = 'login.html';
    }

    // Sidebar keyboard shortcut
    document.addEventListener('keydown', (e)=>{
      if(e.key >= '1' && e.key <= '4'){
        const map = {'1':'chat','2':'symptoms','3':'reports','4':'appointments'};
        nav(map[e.key]);
      }
    });

    // initial
    nav('chat');

    // -----------------------------
    // HISTORY STORAGE FUNCTIONS
    // -----------------------------
    // ----- CONFIG -----
const N8N_SAVE_URL = "https://pavanxd.app.n8n.cloud/webhook/Chatbot"; // set to your webhook URL
const N8N_KEY = "YOUR_SIMPLE_KEY"; // optional, put in query string like ?key=...

// ----- HISTORY STORAGE (local + server) -----
function loadHistoryData() {
  try {
    return JSON.parse(localStorage.getItem('clinix_history') || '[]');
  } catch (e) {
    console.warn("history load failed", e);
    return [];
  }
}

function saveHistoryData(arr) {
  try {
    localStorage.setItem('clinix_history', JSON.stringify(arr));
  } catch (e) {
    console.warn("history save failed", e);
  }
}

/**
 * Push a history item:
 * role: "user"|"assistant"|"symptom"|"system"
 * text: the text content to save
 * meta: optional object { duration, severity, username }
 */
function pushHistory(role, text, meta = {}) {
  const username = localStorage.getItem('userName') || 'User';
  const item = {
    role,
    text,
    time: new Date().toISOString(),
    username,
    meta
  };

  // 1) save locally (fast)
  const hist = loadHistoryData();
  hist.unshift(item); // newest first
  // cap to 200 items to avoid huge localStorage
  if (hist.length > 200) hist.pop();
  saveHistoryData(hist);

  // 2) update quick recent activity shown in aside
  updateRecentPreview(item);

  // 3) send to n8n webhook (non-blocking)
  // include simple key if you configured one
  const url = N8N_KEY ? `${N8N_SAVE_URL}?key=${encodeURIComponent(N8N_KEY)}` : N8N_SAVE_URL;
  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(item),
  })
  .then(r => r.json())
  .then(res => {
    // optional: you can mark item as saved on server by storing res.id if your n8n creates an id
    // console.log("history saved to server", res);
  })
  .catch(err => {
    // network may be offline ‚Äî that's fine, the local copy remains
    console.warn("Could not save history to server:", err);
  });
}

function updateRecentPreview(item) {
  // show a short summary in the aside "Recent activity" line
  const text = (item.role === 'symptom')
    ? `Symptom: ${truncate(item.text, 60)}`
    : (item.role === 'assistant' ? `AI: ${truncate(item.text, 60)}` : `${item.username}: ${truncate(item.text, 60)}`);
  document.getElementById('recent').textContent = text;
}

function truncate(str, n) {
  if (!str) return '';
  return (str.length > n) ? str.slice(0, n-1) + '‚Ä¶' : str;
}

// ----- Hook into existing flows -----
// 1) chat: in sendChat() after showing user bubble and before or after AI reply push the items
// Replace your pushHistory("user", text) with the new signature (meta optional)
/// Example: pushHistory("user", text);

// and when AI replies: pushHistory("assistant", reply);

// 2) symptoms: replace your updateRecent(...) call with pushHistory
// in analyzeSymptoms() change:
 // updateRecent(`Symptom check: "${t}"`);
 // to:
 pushHistory("symptom", t, { duration: dur, severity: sev });

// ----- View History modal functions -----
function openHistory() {
  // populate modal quickly from localStorage
  const hist = loadHistoryData();
  renderHistoryList(hist);

  // show modal
  const m = document.getElementById('historyModal');
  m.style.display = 'flex';
  m.querySelector('div').focus?.();

  // optionally: fetch server history to merge (non-blocking)
  // fetchServerHistoryAndMerge();
}

function closeHistory() {
  document.getElementById('historyModal').style.display = 'none';
}

function renderHistoryList(hist) {
  const el = document.getElementById('historyList');
  el.innerHTML = '';
  if (!hist || hist.length === 0) {
    el.innerHTML = '<div style="color:var(--muted)">No history yet.</div>';
    return;
  }

  hist.forEach(item => {
    const wrapper = document.createElement('div');
    wrapper.style.padding = '8px';
    wrapper.style.borderBottom = '1px solid #f1f5f9';
    wrapper.innerHTML = `
      <div style="font-size:13px; color:#374151"><strong>${escapeHtml(item.role === 'symptom' ? 'Symptom check' : item.role)}</strong>
        <span style="color:var(--muted); font-size:12px; margin-left:8px">${new Date(item.time).toLocaleString()}</span>
      </div>
      <div style="margin-top:6px; font-size:14px; color:#0f172a">${escapeHtml(truncate(item.text, 600))}</div>
      ${item.meta && Object.keys(item.meta).length ? `<div style="margin-top:6px; color:var(--muted); font-size:13px">${escapeHtml(JSON.stringify(item.meta))}</div>` : ''}
    `;
    el.appendChild(wrapper);
  });
}

// Optional: fetch server-side history and merge into localStorage.
// Useful if user used different device / cleared localStorage but you still have server records.
// Implement only if you want merge capability and have a GET endpoint in n8n that returns history.
function fetchServerHistoryAndMerge() {
  const url = N8N_KEY ? `${N8N_SAVE_URL}?key=${encodeURIComponent(N8N_KEY)}` : N8N_SAVE_URL;
  // assume your n8n can respond to GET with JSON array
  fetch(url, { method: 'GET' })
    .then(r => r.json())
    .then(serverHist => {
      if (!Array.isArray(serverHist)) return;
      const local = loadHistoryData();
      // naive merge: create map by time+text to avoid duplicates
      const map = {};
      local.concat(serverHist).forEach(it => {
        const k = (it.time || '') + '|' + (it.text || '').slice(0,120);
        if (!map[k]) map[k] = it;
      });
      const merged = Object.values(map).sort((a,b)=> new Date(b.time)-new Date(a.time));
      saveHistoryData(merged);
      renderHistoryList(merged);
    })
    .catch(err => console.warn("Could not fetch server history", err));
}


    // ---- Robust history save + server POST + preview update ----
function saveHistoryData(arr) {
  try {
    localStorage.setItem('clinix_history', JSON.stringify(arr));
  } catch (e) {
    console.warn("history save failed", e);
  }
}

/**
 * role: "user" | "assistant" | "symptom" | "system"
 * text: string
 * meta: optional object e.g. { duration, severity }
 */
function pushHistory(role, text, meta = {}) {
  const username = localStorage.getItem('userName') || document.getElementById('userName')?.textContent?.trim() || 'User';
  const item = {
    role,
    text: String(text || ''),
    meta: meta || {},
    time: new Date().toISOString(),
    username
  };

  // save locally (newest first)
  const hist = loadHistoryData();
  hist.unshift(item);
  // cap size
  if (hist.length > 500) hist.length = 500;
  saveHistoryData(hist);

  // update the aside preview quickly
  updateRecentPreview(item);

  // update history modal if it's open (keeps UI sync)
  if (document.getElementById('historyModal') && document.getElementById('historyModal').style.display !== 'none') {
    renderHistoryList(loadHistoryData());
  }

  // Post to n8n webhook (non-blocking). If network fails, keep local only (you have retry logic optionally)
  try {
    const url = (typeof N8N_KEY !== 'undefined' && N8N_KEY) ? `${N8N_SAVE_URL}?key=${encodeURIComponent(N8N_KEY)}` : N8N_SAVE_URL;
    if (url) {
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(item)
      })
      .then(r => {
        if (!r.ok) console.warn('n8n save returned', r.status);
        return r.json().catch(()=>({}));
      })
      .then(_ => {
        // optionally tag item as saved by server (not required)
      })
      .catch(err => {
        console.warn('Could not save history to server:', err);
      });
    }
  } catch (e) {
    console.warn('pushHistory post exception', e);
  }
}

function updateRecentPreview(item) {
  const preview = document.getElementById('recent');
  if (!preview) return;
  const short = (item.role === 'symptom') 
    ? `Symptom: ${truncate(item.text, 80)}`
    : (item.role === 'assistant' ? `AI: ${truncate(item.text, 80)}` : `${item.username}: ${truncate(item.text, 80)}`);
  preview.textContent = short;
}

function truncate(str, n) {
  if (!str) return '';
  return (str.length > n) ? str.slice(0, n-1) + '‚Ä¶' : str;
}

</script>


</body>
</html>
